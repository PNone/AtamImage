name: Build and Export Docker Images and Containers on Tag

on:
  push:
    tags:
      - 'v*'  # triggers on tag pushes like v1.0.0

jobs:
  build-and-export:
    runs-on: ubuntu-latest

    env:
      OP_SYS_TAG: ${{ github.ref_name }}
      COMMIT_TAG: ${{ github.sha }}

    permissions:
      contents: write  # Required to upload release assets

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Cache Docker layers
        uses: actions/cache@v3
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-buildx-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-buildx-

      # --- Build and export atam-build image ---
      - name: Build and save Atam image to tar
        run: |
          docker buildx build \
            --builder default \
            --platform linux/amd64 \
            --secret id=student_pass_atam,env=STUDENT_PASS_ATAM \
            --secret id=student_uid_atam,env=STUDENT_UID_ATAM \
            -t atam:$COMMIT_TAG \
            -f atam/Atam.Dockerfile atam \
            --cache-from type=local,src=/tmp/.buildx-cache \
            --load
        env:
          STUDENT_PASS_ATAM: ${{ secrets.STUDENT_PASS_ATAM }}
          STUDENT_UID_ATAM: ${{ secrets.STUDENT_UID_ATAM }}

      # --- Save atam image as .tar ---
      - name: Save atam image to tar
        run: docker save atam:$COMMIT_TAG -o AtamUbuntu-image.tar

      # --- Export atam container to .tar ---
      - name: Export atam container
        run: |
          container_id=$(docker run -t -d --name AtamUbuntuContainer atam:$COMMIT_TAG /bin/bash)
          docker export --output=AtamUbuntu-container.tar $container_id

      # --- Build opsys image ---
      - name: Build opsys image (and load into Docker)
        run: |
          docker buildx build \
            --builder default \
            --platform linux/amd64 \
            --secret id=student_pass_os,env=STUDENT_PASS_OS \
            --secret id=student_uid_os,env=STUDENT_UID_OS \
            -t opsys:$COMMIT_TAG \
            -f OperatingSystems/OpSys.Dockerfile OperatingSystems \
            --cache-from type=local,src=/tmp/.buildx-cache \
            --load
        env:
          STUDENT_PASS_OS: ${{ secrets.STUDENT_PASS_OS }}
          STUDENT_UID_OS: ${{ secrets.STUDENT_UID_OS }}

      # --- Save opsys image as .tar ---
      - name: Save opsys image to tar
        run: docker save opsys:$COMMIT_TAG -o OpSysUbuntu-image.tar

      # --- Export opsys container to .tar ---
      - name: Export opsys container
        run: |
          container_id=$(docker run -t -d --name OpSysUbuntuContainer opsys:$COMMIT_TAG /bin/bash)
          docker export --output=OpSysUbuntu-container.tar $container_id

      # --- Upload AtamUbuntu tarball ---
      - name: Upload AtamUbuntu image tarball
        uses: actions/upload-artifact@v4
        with:
           name: AtamUbuntu-Image-Tarball
           path: AtamUbuntu-image.tar
      
      - name: Upload AtamUbuntu container tarball
        uses: actions/upload-artifact@v4
        with:
           name: AtamUbuntu-Container-Tarball
           path: AtamUbuntu-container.tar
 
      # --- Upload OpSysUbuntu tarball ---
      - name: Upload OpSysUbuntu image tarball
        uses: actions/upload-artifact@v4
        with:
           name: OpSysUbuntu-Image-Tarball
           path: OpSysUbuntu-image.tar

      - name: Upload OpSysUbuntu container tarball
        uses: actions/upload-artifact@v4
        with:
           name: OpSysUbuntu-Container-Tarball
           path: OpSysUbuntu-container.tar
      # --- Upload all tars to GitHub Release ---
      - name: Upload all tars to Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            AtamUbuntu-image.tar
            AtamUbuntu-container.tar
            OpSysUbuntu-container.tar
            OpSysUbuntu-image.tar

        env:
          GITHUB_TOKEN: ${{ secrets.GIT_ACCESS_TOKEN }}
